<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,user-scalable=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="mobile-web-app-capable" content="yes"><title>Loading...</title><script defer="defer" src="bundle.js"></script><link href="bundle.css" rel="stylesheet"></head><body><div id="app-container"></div><div id="notification-container"></div>


<script>

(async function() {
    // ---------------- UI 样式定义 (保持不变) ----------------
    const css = `
        #fb-search-widget { position: fixed; top: 10px; right: 10px; width: 300px; background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 99999; border-radius: 4px; font-family: sans-serif; display: flex; flex-direction: column; max-height: 80vh; }
        #fb-search-header { padding: 10px; border-bottom: 1px solid #eee; background: #f8f8f8; border-radius: 4px 4px 0 0; display: flex; gap: 5px; }
        #fb-search-input { flex: 1; padding: 6px; border: 1px solid #ccc; border-radius: 3px; outline: none; }
        #fb-search-status { font-size: 10px; color: #888; padding: 0 10px 5px; background: #f8f8f8; }
        #fb-search-results { overflow-y: auto; flex: 1; padding: 0; margin: 0; list-style: none; }
        .fb-search-item { padding: 8px 10px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .fb-search-item:hover { background: #eefbff; }
        .fb-search-title { font-weight: bold; font-size: 13px; color: #333; display: block; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .fb-search-artist { font-size: 11px; color: #666; }
        .fb-search-idx { font-size: 10px; color: #aaa; background: #eee; padding: 2px 4px; border-radius: 3px; }
        #fb-close-btn { cursor: pointer; color: #999; font-weight: bold; padding: 0 5px; }
    `;
    // 防止重复注入样式
    if (!document.getElementById('fb-search-style')) {
        const style = document.createElement('style');
        style.id = 'fb-search-style';
        style.innerHTML = css;
        document.head.appendChild(style);
    }
    
    // 清理旧的 widget (如果存在)
    const oldWidget = document.getElementById('fb-search-widget');
    if (oldWidget) oldWidget.remove();

    // ---------------- 创建 UI 结构 ----------------
    const widget = document.createElement('div');
    widget.id = 'fb-search-widget';
    widget.innerHTML = `
        <div id="fb-search-header">
            <input type="text" id="fb-search-input" placeholder="输入歌手或歌名...">
            <span id="fb-close-btn" onclick="this.parentElement.parentElement.remove()">✕</span>
        </div>
        <div id="fb-search-status">准备就绪</div>
        <ul id="fb-search-results"></ul>
    `;
    document.body.appendChild(widget);

    const input = widget.querySelector('#fb-search-input');
    const status = widget.querySelector('#fb-search-status');
    const resultsList = widget.querySelector('#fb-search-results');
    
    // ---------------- 核心逻辑 ----------------
    let allTracks = [];      // 存储所有歌曲数据
    let currentPlId = null;  // 当前播放列表 ID

    // 1. 加载数据函数
    async function loadData() {
        try {
            status.innerText = "正在获取列表信息...";
            
            // 获取播放器状态
            const sRes = await fetch('/api/query?player=true&playlists=true');
            const sData = await sRes.json();
            
            // 确定当前播放列表
            currentPlId = sData.player && sData.player.activePlaylist 
                ? sData.player.activePlaylist 
                : (sData.playlists[0] ? sData.playlists[0].id : null);

            if (!currentPlId) {
                status.innerText = "错误：未找到播放列表";
                return;
            }

            status.innerText = `正在下载完整歌曲目录...`;
            // plrange 决定了我们下载多少首歌，0:20000 表示下载前2万首
            const iRes = await fetch(`/api/query?playlistItems=true&plcolumns=%artist% - %title%&plref=${currentPlId}&plrange=0:20000`);
            const iData = await iRes.json();

            // 解析数据结构
            let rawItems = [];
            let offset = 0;

            if (iData.playlistItems) {
                rawItems = iData.playlistItems.items || [];
                offset = iData.playlistItems.offset || 0;
            } else if (iData.playlist) {
                rawItems = iData.playlist.items || [];
                offset = 0; // 旧版API通常是0
            } else if (iData.playlists && iData.playlists[0]) {
                rawItems = iData.playlists[0].items || [];
            }

            // 【关键修复】：手动给每首歌加上真实的索引号 (Offset + 数组下标)
            allTracks = rawItems.map((item, index) => {
                return {
                    columns: item.columns, // 歌名信息
                    _realIndex: offset + index // 修复：手动计算真实索引
                };
            });

            status.innerText = `索引完成: 共 ${allTracks.length} 首歌曲`;
            
        } catch (e) {
            console.error(e);
            status.innerText = "数据加载失败: " + e.message;
        }
    }

    // 2. 渲染结果函数
    function renderResults(keyword) {
        resultsList.innerHTML = '';
        if (!keyword) return;

        const term = keyword.toLowerCase();
        
        // 过滤数据
        const matches = allTracks.filter(item => {
            const text = (item.columns && item.columns[0]) ? item.columns[0] : '';
            return text.toLowerCase().includes(term);
        }).slice(0, 100); 

        if (matches.length === 0) {
            resultsList.innerHTML = '<li style="padding:10px;color:#999;text-align:center">无匹配结果</li>';
            return;
        }

        matches.forEach(track => {
            const li = document.createElement('li');
            li.className = 'fb-search-item';
            
            const fullText = track.columns[0];
            let title = fullText;
            let artist = '';
            if (fullText.includes(' - ')) {
                const parts = fullText.split(' - ');
                artist = parts[0];
                title = parts.slice(1).join(' - ');
            }

            // 显示
            li.innerHTML = `
                <div style="width: 80%">
                    <span class="fb-search-title">${title}</span>
                    <span class="fb-search-artist">${artist}</span>
                </div>
                <span class="fb-search-idx">#${track._realIndex + 1}</span>
            `;

            // 点击播放逻辑
            li.onclick = async () => {
                const playIndex = track._realIndex; // 使用我们在加载时计算好的 _realIndex
                console.log(`尝试播放: Playlist=${currentPlId}, Index=${playIndex}`);
                
                status.innerText = `正在请求播放: ${title} (#${playIndex})...`;
                
                try {
                    const res = await fetch(`/api/player/play/${currentPlId}/${playIndex}`, { method: 'POST' });
                    if (res.ok) {
                        status.innerText = `播放成功: ${title}`;
                    } else {
                        status.innerText = `播放失败: ${res.statusText}`;
                    }
                } catch(err) {
                    status.innerText = `请求出错: ${err.message}`;
                }
            };

            resultsList.appendChild(li);
        });
    }

    // 3. 事件监听
    input.addEventListener('input', (e) => renderResults(e.target.value));
    
    // 初始化加载
    await loadData();
})();
</script>

</body></html>